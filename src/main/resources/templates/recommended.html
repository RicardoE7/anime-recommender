<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anime Recommendations</title>
    <link rel="stylesheet" href="/css/recommended.css">
    <script defer src="script.js"></script>
</head>
<body>
<header>
    <h1>Welcome, <span id="username">User</span>!</h1>
    <nav>
        <a href="profile.html">Profile</a>
        <a href="logout.html">Logout</a>
    </nav>
</header>

<main>
    <section id="recommendations">
        <h2>Recommended Anime for You</h2>
        <div id="anime-list" class="anime-scroll">
            <!-- Recommended anime will be dynamically inserted here -->
        </div>
    </section>

    <section id="highest-rated">
        <h2>Highest Rated Anime</h2>
        <div id="highest-rated-list" class="anime-scroll">
            <!-- Highest rated anime will be dynamically inserted here -->
        </div>
    </section>
</main>

<!-- Modal for Anime Details -->
<div id="anime-modal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2 id="anime-title">Anime Title</h2>
        <p id="anime-description">Description of the anime.</p>
    </div>
</div>

<footer>
    <p>&copy; 2024 Anime Recommender. All rights reserved.</p>
</footer>

<script>
    const apiUrl = 'https://graphql.anilist.co/';

    async function fetchAnimeRecommendations() {
        const query = `
        {
            Page(page: 1, perPage: 10) {
                media(type: ANIME, sort: POPULARITY_DESC) {
                    id
                    title {
                        romaji
                        english
                    }
                    episodes
                    genres
                    coverImage {
                        large
                    }
                    description
                    averageScore
                }
            }
        }`;

        const options = {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json',
            },
            body: JSON.stringify({ query })
        };

        try {
            const response = await fetch(apiUrl, options);
            const text = await response.text(); // Read response as text
            console.log('Response text:', text); // Log response text for debugging

            const data = JSON.parse(text); // Try parsing the text to JSON
            const animeList = data.data.Page.media;
            displayAnime(animeList, 'anime-list');
        } catch (error) {
            console.error('Error fetching anime recommendations:', error);
        }
    }

    async function fetchHighestRatedAnime() {
        const query = `
        {
            Page(page: 1, perPage: 10) {
                media(type: ANIME, sort: SCORE_DESC) {
                    id
                    title {
                        romaji
                        english
                    }
                    episodes
                    genres
                    coverImage {
                        large
                    }
                    description
                    averageScore
                }
            }
        }`;

        const options = {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json',
            },
            body: JSON.stringify({ query })
        };

        try {
            const response = await fetch(apiUrl, options);
            const text = await response.text(); // Read response as text
            console.log('Response text:', text); // Log response text for debugging

            const data = JSON.parse(text); // Try parsing the text to JSON
            const highestRatedList = data.data.Page.media;
            displayAnime(highestRatedList, 'highest-rated-list');
        } catch (error) {
            console.error('Error fetching highest rated anime:', error);
        }
    }

    function displayAnime(animeList, containerId) {
    const animeListDiv = document.getElementById(containerId);
    animeListDiv.innerHTML = ''; // Clear previous content

    animeList.forEach(anime => {
        // Clean up description by removing <br> tags
        const cleanedDescription = anime.description ? anime.description.replace(/<br\s*\/?>/gi, ' ') : 'No description available';
        // Use English title if available, otherwise fallback to Romaji
        const title = anime.title.english || anime.title.romaji;

        // Create anime card HTML
        const animeCard = document.createElement('div');
        animeCard.classList.add('anime-card');

        // Set the inner HTML of the anime card
        animeCard.innerHTML = `
            <h3>${title}</h3>
            <img src="${anime.coverImage.large}" alt="${title} Cover Image" class="anime-cover">
            <p>${cleanedDescription.substring(0, 100) + '...'}</p>
            <p>Episodes: ${anime.episodes}</p>
            <p>Genres: ${anime.genres.join(', ')}</p>
            <p>Score: ${anime.averageScore}</p>
            <button class="details-btn">Details</button>
            <button class="more-info-btn">More Info</button>
        `;

        // Append the anime card to the list
        animeListDiv.appendChild(animeCard);

        // Attach event listener to the "Details" button
        const detailsButton = animeCard.querySelector('.details-btn');
        detailsButton.addEventListener('click', () => {
            showAnimeDetails(title, cleanedDescription);
        });

        // Attach event listener to the "More Info" button
        const moreInfoButton = animeCard.querySelector('.more-info-btn');
        moreInfoButton.addEventListener('click', () => {
            window.location.href = `anime-details.html?id=${anime.id}`;
        });
    });
}



    function showAnimeDetails(title, description) {
        const modal = document.getElementById('anime-modal');
        const modalTitle = document.getElementById('anime-title');
        const modalDescription = document.getElementById('anime-description');

        // Clean the description for modal, replacing <br> with new lines
        const cleanedDescription = description ? description.replace(/<br\s*\/?>/gi, '\n') : 'No description available';

        modalTitle.textContent = title;
        modalDescription.textContent = cleanedDescription;

        modal.style.display = 'block';

        // Close the modal
        const closeModal = document.getElementsByClassName('close')[0];
        closeModal.onclick = function () {
            modal.style.display = 'none';
        }

        window.onclick = function (event) {
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }
    }

    // Function to enable dragging
    function enableDragScrolling(container) {
        let isDown = false;
        let startX;
        let scrollLeft;

        container.addEventListener('mousedown', (e) => {
            isDown = true;
            container.classList.add('active');
            startX = e.pageX - container.offsetLeft;
            scrollLeft = container.scrollLeft;
        });

        container.addEventListener('mouseleave', () => {
            isDown = false;
            container.classList.remove('active');
        });

        container.addEventListener('mouseup', () => {
            isDown = false;
            container.classList.remove('active');
        });

        container.addEventListener('mousemove', (e) => {
            if (!isDown) return;
            e.preventDefault();
            const x = e.pageX - container.offsetLeft;
            const walk = (x - startX) * 2; // Scroll-fast factor
            container.scrollLeft = scrollLeft - walk;
        });
    }

    // Fetch anime recommendations and highest rated anime when the page loads
    fetchAnimeRecommendations();
    fetchHighestRatedAnime();

    // Enable drag scrolling for anime lists
    enableDragScrolling(document.getElementById('anime-list'));
    enableDragScrolling(document.getElementById('highest-rated-list'));
</script>

</body>
</html>
